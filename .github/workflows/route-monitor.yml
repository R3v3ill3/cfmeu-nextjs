name: Route Monitor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekdays at 9 AM UTC
    - cron: '0 9 * * 1-5'
  workflow_dispatch:

jobs:
  route-monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Route Monitor
      run: npx tsx scripts/analyze-missing-routes.ts

    - name: Check for High Priority Issues
      run: |
        if grep -q "ðŸš¨ HIGH PRIORITY ISSUES:" missing-routes-report.json &&            grep -q -v "âœ… No high priority issues found" missing-routes-report.json; then
          echo "::error::High priority route issues detected!"
          cat missing-routes-report.json
          exit 1
        fi

    - name: Upload Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: route-monitor-report
        path: missing-routes-report.json

    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          if (fs.existsSync('missing-routes-report.json')) {
            const report = JSON.parse(fs.readFileSync('missing-routes-report.json', 'utf8'));

            if (report.summary.highPriorityIssues > 0) {
              const body = `## ðŸš¨ Route Monitor Report

              **High Priority Issues:** ${report.summary.highPriorityIssues}
              **Missing Routes:** ${report.summary.missingRoutes}

              <details>
              <summary>View Details</summary>

              \`\`\`json
              ${JSON.stringify(report.routes.filter(r => r.priority === 'HIGH'), null, 2)}
              \`\`\`

              </details>

              Please review and fix these issues before merging.
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
          }
